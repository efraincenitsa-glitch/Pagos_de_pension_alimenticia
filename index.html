<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Pensi贸n ULTRA PRO </title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f172a">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Pensi贸n PRO">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" sizes="1024x1024" href="icono-1024.png">

<style>
:root{--bg:#0f172a;--card:#1e293b;--header:#111827;--text:#fff;--ok:#22c55e;--danger:#ef4444;}
body{margin:0;font-family:Arial;background:var(--bg);color:var(--text);}
header{background:var(--header);padding:16px;text-align:center;font-size:22px;font-weight:bold;}
.container{padding:15px;max-width:720px;margin:auto;}
.card{background:var(--card);padding:15px;border-radius:14px;margin-bottom:15px;}
input,select,button{width:100%;padding:12px;margin:6px 0;border:none;border-radius:10px;font-size:16px;}
button{background:var(--ok);color:#fff;font-weight:bold;}
.delete{background:var(--danger);}
.edit{background:#3b82f6;}
.item{background:#0f172a;padding:12px;border-radius:12px;margin-bottom:10px;}
.small{padding:8px;margin-top:6px;}
.logout{background:#f59e0b;}
.login{background:#3b82f6;}
</style>
</head>

<body>

<header>Pensi贸n Alimenticia  PRIVADA</header>

<div class="container">

<div id="loginBox" class="card" style="text-align:center">
<h3>Acceso privado</h3>
<button class="login" onclick="login()">Entrar con Google</button>
</div>

<div id="app" style="display:none">

<div class="card">
<button class="logout" onclick="logout()">Cerrar sesi贸n</button>
</div>

<div class="card">
<h3>Registrar Pago</h3>

<input id="porcentaje" placeholder="Porcentaje %">
<input id="ingreso" placeholder="Ingreso">
<select id="periodo">
<option>Semanal</option>
<option>Catorcenal</option>
<option>Quincenal</option>
<option>Mensual</option>
</select>

<input id="fecha" type="date">

<button onclick="registrar()">Registrar Pago</button>

<div id="resultado"></div>
</div>

<div class="card">
<h3>Historial</h3>
<div id="historial"></div>
<button class="delete" onclick="borrarTodo()">Borrar Todo</button>
</div>

</div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<script>
//  TU CONFIG
const firebaseConfig = {
  apiKey: "AIzaSyDTV8IdIsfFFU5X30dOckR5_9pmLqgidBY",
  authDomain: "pensionpro-1e559.firebaseapp.com",
  databaseURL: "https://pensionpro-1e559-default-rtdb.firebaseio.com",
  projectId: "pensionpro-1e559",
  storageBucket: "pensionpro-1e559.firebasestorage.app",
  messagingSenderId: "354313368373",
  appId: "1:354313368373:web:becef8b8ff21d51c58927c"
};

firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.database();

let userId = null;
let datos = [];
let editIndex = null;

fecha.value = new Date().toISOString().split('T')[0];

//  LOGIN
function login(){
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider);
}

//  LOGOUT
function logout(){
  auth.signOut();
}

//  CAMBIO DE SESIN
auth.onAuthStateChanged(user=>{
  if(user){
    userId = user.uid;
    loginBox.style.display="none";
    app.style.display="block";
    cargarDatos();
  }else{
    loginBox.style.display="block";
    app.style.display="none";
  }
});

// 锔 CARGAR DESDE NUBE
function cargarDatos(){
  db.ref("usuarios/"+userId+"/pension").once("value",snap=>{
    datos = snap.val() || [];
    mostrar();
  });
}

// 锔 GUARDAR EN NUBE
function guardarNube(){
  db.ref("usuarios/"+userId+"/pension").set(datos);
}

function registrar(){
  const p = parseFloat(porcentaje.value);
  const ing = parseFloat(ingreso.value);
  if(isNaN(p)||isNaN(ing)){alert("Completa datos");return;}

  const pen = ing*p/100;
  const libre = ing-pen;

  const r={
    fecha:fecha.value,
    porcentaje:p,
    ingreso:ing,
    periodo:periodo.value,
    pension:pen,
    libre:libre
  };

  if(editIndex!==null){
    datos[editIndex]=r;
    editIndex=null;
  }else{
    datos.push(r);
  }

  guardarNube();

  resultado.innerHTML =
    `Pensi贸n: $${pen.toFixed(2)}<br>Libre: $${libre.toFixed(2)}`;

  mostrar();
}

function mostrar(){
  historial.innerHTML="";
  datos.slice().reverse().forEach((r,i)=>{
    const idx = datos.length-1-i;

    historial.innerHTML+=`
    <div class="item">
    <b>${r.fecha}</b> (${r.periodo})<br>
    Ingreso: $${r.ingreso}<br>
    %: ${r.porcentaje}<br>
    Pensi贸n: $${r.pension.toFixed(2)}<br>
    Libre: $${r.libre.toFixed(2)}

    <button class="small edit" onclick="editar(${idx})">Modificar</button>
    <button class="small delete" onclick="eliminar(${idx})">Eliminar</button>
    </div>`;
  });
}

function editar(idx){
  const r = datos[idx];
  porcentaje.value=r.porcentaje;
  ingreso.value=r.ingreso;
  periodo.value=r.periodo;
  fecha.value=r.fecha;
  editIndex=idx;
  window.scrollTo({top:0,behavior:'smooth'});
}

function eliminar(idx){
  if(confirm("驴Eliminar registro?")){
    datos.splice(idx,1);
    guardarNube();
    mostrar();
  }
}

function borrarTodo(){
  if(confirm("驴Borrar todo?")){
    datos=[];
    guardarNube();
    mostrar();
    resultado.innerHTML="";
  }
}
</script>

</body>
</html>
