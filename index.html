<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Pensión PRO</title>

<link rel="apple-touch-icon" sizes="1024x1024" href="icono-1024.png">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">

<style>
  :root{
    --bg:#0f172a;        /* slate-900 */
    --card:#1e293b;      /* slate-800 */
    --header:#111827;    /* gray-900  */
    --text:#ffffff;
    --muted:#9ca3af;     /* gray-400 */
    --ok:#22c55e;        /* green-500 */
    --danger:#ef4444;    /* red-500 */
  }

  *{ box-sizing:border-box; }
  body{
    margin:0;
    font-family:Arial, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell;
    background:var(--bg);
    color:var(--text);
  }

  header{
    background:var(--header);
    padding:16px;
    text-align:center;
    font-size:22px;
    font-weight:bold;
  }

  .container{ padding:15px; max-width:720px; margin:0 auto; }

  .card{
    background:var(--card);
    padding:15px;
    border-radius:14px;
    margin-bottom:15px;
  }

  .row{ display:grid; gap:10px; grid-template-columns:1fr; }
  .row-2{ grid-template-columns:1fr; }
  @media (min-width:560px){
    .row-2{ grid-template-columns:1fr 1fr; }
  }

  label{ display:block; margin:6px 0 2px; font-weight:600; }

  input, select{
    width:100%;
    padding:12px;
    margin:6px 0;
    border:none;
    border-radius:10px;
    font-size:16px;
    background:#0b1226;
    color:var(--text);
    outline:none;
  }

  button{
    width:100%;
    padding:14px;
    margin-top:8px;
    border:none;
    border-radius:12px;
    font-size:18px;
    font-weight:bold;
    background:var(--ok);
    color:white;
    cursor:pointer;
  }
  button:disabled{ opacity:.6; cursor:not-allowed; }
  .delete{ background:var(--danger); }

  .btn-row{
    display:flex;
    gap:10px;
    margin-top:8px;
  }
  .btn-secondary{ background:#334155; color:#fff; }

  .small{
    font-size:14px;
    padding:8px 10px;
    border-radius:10px;
    width:auto;
  }
  .small.danger{ background:var(--danger); }
  .small.edit{ background:#3b82f6; }

  .item{
    background:#0f172a;
    padding:12px;
    border-radius:12px;
    margin-bottom:10px;
    border:1px solid rgba(255,255,255,.06);
  }
  .item-top{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin-bottom:6px;
  }
  .tag{
    display:inline-block;
    padding:2px 8px;
    border-radius:999px;
    background:#0b1226;
    border:1px solid rgba(255,255,255,.08);
    color:#cbd5e1;
    font-size:12px;
  }

  #estadoEdicion{
    font-size:14px;
    color:#fbbf24;
    margin-top:6px;
  }
</style>
</head>

<body>

<header>Pensión Alimenticia PRO</header>

<div class="container">

  <div class="card">
    <h3>Configuración</h3>

    <div class="row row-2">
      <div>
        <label for="porcentaje">Porcentaje</label>
        <input id="porcentaje" type="text" placeholder="Ej. 30%" inputmode="decimal" autocomplete="off">
      </div>

      <div>
        <label for="ingreso">Ingreso</label>
        <input id="ingreso" type="text" placeholder="Ej. $6,000.00" inputmode="decimal" autocomplete="off">
      </div>
    </div>

    <div class="row row-2">
      <div>
        <label for="periodo">Periodo</label>
        <select id="periodo">
          <option>Semanal</option>
          <option>Catorcenal</option>
          <option>Quincenal</option>
          <option>Mensual</option>
        </select>
      </div>

      <div>
        <label for="fecha">Fecha</label>
        <input id="fecha" type="date">
      </div>
    </div>

    <div class="btn-row">
      <button type="button" id="btnRegistrar">Registrar Pago</button>
      <button type="button" id="btnCancelar" class="btn-secondary" style="display:none">Cancelar edición</button>
    </div>

    <div id="estadoEdicion"></div>
    <div id="resultado" style="margin-top:10px;"></div>
  </div>

  <div class="card">
    <h3>Historial</h3>
    <div id="historial"></div>
    <button class="delete" type="button" id="btnBorrarTodo">Borrar Todo</button>
  </div>

</div>

<script>
  function parseLocaleNumber(str) {
    if (!str) return NaN;
    let s = String(str).trim();
    s = s.replace(/[^0-9.,-]/g, '');
    if (!s) return NaN;
    const lastComma = s.lastIndexOf(',');
    const lastDot   = s.lastIndexOf('.');
    let decimalSep = null;
    if (lastComma === -1 && lastDot === -1) {
      return parseFloat(s.replace(/[^\d-]/g, ''));
    }
    if (lastDot > lastComma) decimalSep = '.';
    else if (lastComma > -1) decimalSep = ',';
    let normalized = s;
    if (decimalSep) {
      const thousandsRE = decimalSep === '.' ? /,/g : /\./g;
      normalized = normalized.replace(thousandsRE, '');
      normalized = normalized.replace(decimalSep, '.');
    }
    const parts = normalized.split('.');
    if (parts.length > 2) normalized = parts.shift() + '.' + parts.join('');
    const n = parseFloat(normalized);
    return Number.isFinite(n) ? n : NaN;
  }

  function formatMoney(n) {
    if (!Number.isFinite(n)) return '';
    return n.toLocaleString('es-MX', { style: 'currency', currency: 'MXN' });
  }

  function getCurrencyValue(str) { return parseLocaleNumber(str); }
  function getPercentValue(str) {
    const n = parseLocaleNumber(str);
    if (!Number.isFinite(n)) return NaN;
    return Math.min(100, Math.max(0, n));
  }

  const elPorcentaje = document.getElementById('porcentaje');
  const elIngreso    = document.getElementById('ingreso');
  const elPeriodo    = document.getElementById('periodo');
  const elFecha      = document.getElementById('fecha');
  const btnRegistrar = document.getElementById('btnRegistrar');
  const btnCancelar  = document.getElementById('btnCancelar');
  const btnBorrarAll = document.getElementById('btnBorrarTodo');
  const resultadoEl  = document.getElementById('resultado');
  const historialEl  = document.getElementById('historial');

  elFecha.value = new Date().toISOString().split('T')[0];

  let datos = JSON.parse(localStorage.getItem('pensionPRO')) || [];

  function calcular(p, ingreso) {
    const pension = ingreso * p / 100;
    return { pension, libre: ingreso - pension };
  }

  function registrar() {
    const pVal = getPercentValue(elPorcentaje.value);
    const ingresoVal = getCurrencyValue(elIngreso.value);
    const periodoVal = elPeriodo.value;
    const fechaVal   = elFecha.value;

    if (!Number.isFinite(pVal) || !Number.isFinite(ingresoVal)) {
      alert('Completa los datos.');
      return;
    }

    const r = calcular(pVal, ingresoVal);

    datos.push({
      fecha: fechaVal,
      porcentaje: pVal,
      ingreso: ingresoVal,
      periodo: periodoVal,
      pension: r.pension,
      libre: r.libre
    });

    localStorage.setItem('pensionPRO', JSON.stringify(datos));

    resultadoEl.innerHTML =
      `<b>Pensión:</b> ${formatMoney(r.pension)}<br>
       <b>Libre:</b> ${formatMoney(r.libre)}`;

    mostrarHistorial();
  }

  function mostrarHistorial() {
    historialEl.innerHTML = '';
    if (datos.length === 0) {
      historialEl.innerHTML = '<div class="item">Sin registros</div>';
      return;
    }

    datos.slice().reverse().forEach(r => {
      historialEl.innerHTML += `
        <div class="item">
          <b>${r.fecha}</b> (${r.periodo})<br>
          Ingreso: ${formatMoney(r.ingreso)}<br>
          %: ${r.porcentaje}%<br>
          Pensión: ${formatMoney(r.pension)}<br>
          Libre: ${formatMoney(r.libre)}
        </div>`;
    });
  }

  btnRegistrar.addEventListener('click', registrar);
  btnBorrarAll.addEventListener('click', () => {
    if (confirm('¿Borrar todo?')) {
      datos = [];
      localStorage.removeItem('pensionPRO');
      mostrarHistorial();
      resultadoEl.innerHTML = '';
    }
  });

  mostrarHistorial();
</script>

</body>
</html>
