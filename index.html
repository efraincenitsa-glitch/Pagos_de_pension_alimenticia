<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Pensi贸n PRO ULTRA</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f172a">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Pensi贸n PRO">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" sizes="1024x1024" href="icono-1024.png">

<style>
:root{--bg:#0f172a;--card:#1e293b;--header:#111827;--text:#fff;--ok:#22c55e;--danger:#ef4444;}
body{margin:0;font-family:Arial;background:var(--bg);color:var(--text);}
header{background:var(--header);padding:16px;text-align:center;font-size:22px;font-weight:bold;}
.container{padding:15px;max-width:720px;margin:auto;}
.card{background:var(--card);padding:15px;border-radius:14px;margin-bottom:15px;}
input,select,button{width:100%;padding:12px;margin:6px 0;border:none;border-radius:10px;font-size:16px;}
button{background:var(--ok);color:#fff;font-weight:bold;}
.delete{background:var(--danger);}
.edit{background:#3b82f6;}
.item{background:#0f172a;padding:12px;border-radius:12px;margin-bottom:10px;}
.small{padding:8px;margin-top:6px;}
#loginBox{text-align:center;margin-top:40px;}
</style>
</head>

<body>

<header>Pensi贸n Alimenticia PRO ULTRA </header>

<div id="loginBox">
<button onclick="login()">Iniciar sesi贸n con Google</button>
</div>

<div class="container" id="app" style="display:none;">

<div class="card">
<h3>Configuraci贸n</h3>

<input id="porcentaje" placeholder="Porcentaje %">
<input id="ingreso" placeholder="Ingreso">
<select id="periodo">
<option>Semanal</option>
<option>Catorcenal</option>
<option>Quincenal</option>
<option>Mensual</option>
</select>

<input id="fecha" type="date">

<button onclick="registrar()">Registrar Pago</button>

<div id="resultado"></div>
</div>

<div class="card">
<h3>Historial</h3>
<div id="historial"></div>
<button class="delete" onclick="borrarTodo()">Borrar Todo</button>
<button onclick="logout()">Cerrar sesi贸n</button>
</div>

</div>

<!-- FIREBASE -->
<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getAuth,
  GoogleAuthProvider,
  signInWithPopup,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

import {
  getFirestore,
  collection,
  addDoc,
  getDocs,
  deleteDoc,
  doc,
  query,
  where
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDTV8IdIsfFFU5X30dOckR5_9pmLqgidBY",
  authDomain: "pensionpro-1e559.firebaseapp.com",
  projectId: "pensionpro-1e559",
  storageBucket: "pensionpro-1e559.firebasestorage.app",
  messagingSenderId: "354313368373",
  appId: "1:354313368373:web:becef8b8ff21d51c58927c"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

const EMAIL_AUTORIZADO = "jose.efrass@gmail.com";

window.login = async () => {
  const result = await signInWithPopup(auth, provider);

  if(result.user.email !== EMAIL_AUTORIZADO){
    alert("Acceso no autorizado");
    signOut(auth);
  }
};

window.logout = () => signOut(auth);

onAuthStateChanged(auth, user => {
  if(user && user.email === EMAIL_AUTORIZADO){
    loginBox.style.display="none";
    app.style.display="block";
    cargarDatos(user.uid);
  }else{
    loginBox.style.display="block";
    app.style.display="none";
  }
});

fecha.value = new Date().toISOString().split('T')[0];

async function registrar(){
  const p = parseFloat(porcentaje.value);
  const ing = parseFloat(ingreso.value);

  if(isNaN(p)||isNaN(ing)){alert("Completa datos");return;}

  const pen = ing*p/100;
  const libre = ing-pen;

  const r={
    uid: auth.currentUser.uid,
    fecha:fecha.value,
    porcentaje:p,
    ingreso:ing,
    periodo:periodo.value,
    pension:pen,
    libre:libre
  };

  await addDoc(collection(db,"pagos"), r);

  resultado.innerHTML =
    `Pensi贸n: $${pen.toFixed(2)}<br>Libre: $${libre.toFixed(2)}`;

  cargarDatos(auth.currentUser.uid);
}

async function cargarDatos(uid){
  historial.innerHTML="";
  const q = query(collection(db,"pagos"), where("uid","==",uid));
  const snap = await getDocs(q);

  snap.forEach(docu=>{
    const r = docu.data();

    historial.innerHTML+=`
    <div class="item">
    <b>${r.fecha}</b> (${r.periodo})<br>
    Ingreso: $${r.ingreso}<br>
    %: ${r.porcentaje}<br>
    Pensi贸n: $${r.pension.toFixed(2)}<br>
    Libre: $${r.libre.toFixed(2)}
    <button class="small delete" onclick="eliminar('${docu.id}')">Eliminar</button>
    </div>`;
  });
}

window.eliminar = async id =>{
  await deleteDoc(doc(db,"pagos",id));
  cargarDatos(auth.currentUser.uid);
};

window.borrarTodo = async ()=>{
  if(confirm("驴Borrar todo?")){
    const q = query(collection(db,"pagos"), where("uid","==",auth.currentUser.uid));
    const snap = await getDocs(q);
    snap.forEach(d=>deleteDoc(d.ref));
    cargarDatos(auth.currentUser.uid);
  }
};

</script>

</body>
</html>
